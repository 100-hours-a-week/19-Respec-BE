name: Deploy Backend to EC2

on:
  push:
    branches:
      - stage
 
jobs:
  deploy: 
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            REPO_DIR=19-Respec-BE
            LOG_FILE=~/backend.log

            if [ ! -d "$REPO_DIR" ]; then
              git clone https://github.com/100-hours-a-week/19-Respec-BE.git
            fi

            cd $REPO_DIR
            git checkout stage
            git pull origin stage

            echo "ðŸ“¦ application.properties ìƒì„± ì¤‘..."
            mkdir -p src/main/resources
            echo "spring.datasource.url=${{ secrets.DB_URL }}" > src/main/resources/application.properties
            echo "spring.datasource.username=${{ secrets.DB_USERNAME }}" >> src/main/resources/application.properties
            echo "spring.datasource.password=${{ secrets.DB_PASSWORD }}" >> src/main/resources/application.properties
            echo "spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver" >> src/main/resources/application.properties
            echo "spring.jpa.hibernate.ddl-auto=none" >> src/main/resources/application.properties
            echo "spring.jpa.show-sql=false" >> src/main/resources/application.properties
            echo "spring.jpa.properties.hibernate.format_sql=false" >> src/main/resources/application.properties
            echo "server.port=8080" >> src/main/resources/application.properties
            echo "spring.profiles.active=auth, ai, no-spec-initialize, no-user-initialize" >> src/main/resources/application.properties
            echo "spring.jwt.secret=${{ secrets.JWT_SECRET }}" >> src/main/resources/application.properties
            echo "spring.security.oauth2.client.registration.kakao.client-name=kakao" >> src/main/resources/application.properties
            echo "spring.security.oauth2.client.registration.kakao.client-id=${{ secrets.KAKAO_CLIENT_ID }}" >> src/main/resources/application.properties
            echo "spring.security.oauth2.client.registration.kakao.client-secret=${{ secrets.KAKAO_CLIENT_SECRET }}" >> src/main/resources/application.properties
            echo "spring.security.oauth2.client.registration.kakao.redirect-uri=\${backend.base-url}/login/oauth2/code/kakao" >> src/main/resources/application.properties
            echo "spring.security.oauth2.client.registration.kakao.authorization-grant-type=authorization_code" >> src/main/resources/application.properties
            echo "spring.security.oauth2.client.registration.kakao.client-authentication-method=client_secret_post" >> src/main/resources/application.properties
            echo "spring.security.oauth2.client.provider.kakao.authorization-uri=https://kauth.kakao.com/oauth/authorize" >> src/main/resources/application.properties
            echo "spring.security.oauth2.client.provider.kakao.token-uri=https://kauth.kakao.com/oauth/token" >> src/main/resources/application.properties
            echo "spring.security.oauth2.client.provider.kakao.user-info-uri=https://kapi.kakao.com/v2/user/me" >> src/main/resources/application.properties
            echo "spring.security.oauth2.client.provider.kakao.user-name-attribute=id" >> src/main/resources/application.properties
            echo "spring.cloud.aws.s3.enabled=false" >> src/main/resources/application.properties
            echo "spring.cloud.aws.stack.auto=false" >> src/main/resources/application.properties
            echo "logging.level.org.springframework.security.oauth2.client=DEBUG" >> src/main/resources/application.properties
            echo "logging.level.org.springframework.web.client.RestTemplate=DEBUG" >> src/main/resources/application.properties
            echo "mock.login.user=false" >> src/main/resources/application.properties
            echo "backend.base-url=${{ secrets.BACKEND_BASE_URL }}" >> src/main/resources/application.properties
            echo "frontend.base-url=${{ secrets.FRONTEND_BASE_URL }}" >> src/main/resources/application.properties
            echo "frontend.redirect-url=\${frontend.base-url}/oauth-redirect" >> src/main/resources/application.properties
            echo "spring.graphql.cors.allowed-origins=\${frontend.base-url}" >> src/main/resources/application.properties
            echo "ai.server.url=${{ secrets.AI_SERVER_URL }}" >> src/main/resources/application.properties
            echo "ai.server.url.path=/spec/v1/post" >> src/main/resources/application.properties

            echo "â˜• JAVA_HOME ì„¤ì • ì¤‘..."
            export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which javac))))
            export PATH=$JAVA_HOME/bin:$PATH
            echo "âœ… JAVA_HOME: $JAVA_HOME"

            echo "ðŸš€ Spring Boot í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹œìž‘ (í…ŒìŠ¤íŠ¸ ìƒëžµ)..."
            ./gradlew clean build --no-daemon --refresh-dependencies -x test || { echo "âŒ ë¹Œë“œ ì‹¤íŒ¨"; exit 1; }

            JAR_FILE=$(find build/libs -name "*.jar" | head -n 1)

            if [ -z "$JAR_FILE" ]; then
              echo "âŒ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi

            echo "âœ… JAR íŒŒì¼ ì°¾ìŒ: $(basename "$JAR_FILE")"

            echo "ðŸ” ë°±ì—”ë“œ ì„œë²„ ìž¬ì‹œìž‘..."
            EXISTING_PID=$(pgrep -f 'java -jar')
            if [ -n "$EXISTING_PID" ]; then
              echo "ðŸ›‘ ê¸°ì¡´ ë°±ì—”ë“œ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (PID: $EXISTING_PID)"
              kill $EXISTING_PID
              sleep 2
            else
              echo "âœ… ì‹¤í–‰ ì¤‘ì¸ ë°±ì—”ë“œ ì—†ìŒ"
            fi

            echo "ðŸš€ ìƒˆë¡œìš´ ë°±ì—”ë“œ ì‹¤í–‰ ì¤‘..."
            nohup java -jar "$JAR_FILE" --server.port=8080 --spring.profiles.active=auth,ai,no-spec-initialize,no-user-initialize > $LOG_FILE 2>&1 &

            echo "âœ… ë°±ì—”ë“œ ì‹¤í–‰ ì™„ë£Œ (ë¡œê·¸: $LOG_FILE)"
