name: Deploy Backend to EC2

on:
  push:
    branches:
      - stage

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            REPO_DIR=19-Respec-BE
            LOG_FILE=~/backend.log

            if [ ! -d "$REPO_DIR" ]; then
              git clone https://github.com/100-hours-a-week/19-Respec-BE.git
            fi

            cd $REPO_DIR
            git checkout stage
            git pull origin stage

            echo "üì¶ application.properties ÏÉùÏÑ± Ï§ë (Secrets Í∏∞Î∞ò)..."
            cat <<'EOF' > src/main/resources/application.properties
spring.datasource.url=${{ secrets.DB_URL }}
spring.datasource.username=${{ secrets.DB_USERNAME }}
spring.datasource.password=${{ secrets.DB_PASSWORD }}
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.jpa.hibernate.ddl-auto=none
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.format_sql=false
server.port=8080
spring.profiles.active=auth, ai, no-spec-initialize, no-user-initialize

spring.jwt.secret=${{ secrets.JWT_SECRET }}

spring.security.oauth2.client.registration.kakao.client-name=kakao
spring.security.oauth2.client.registration.kakao.client-id=${{ secrets.KAKAO_CLIENT_ID }}
spring.security.oauth2.client.registration.kakao.client-secret=${{ secrets.KAKAO_CLIENT_SECRET }}
spring.security.oauth2.client.registration.kakao.redirect-uri=\${backend.base-url}/login/oauth2/code/kakao
spring.security.oauth2.client.registration.kakao.authorization-grant-type=authorization_code
spring.security.oauth2.client.registration.kakao.client-authentication-method=client_secret_post

spring.security.oauth2.client.provider.kakao.authorization-uri=https://kauth.kakao.com/oauth/authorize
spring.security.oauth2.client.provider.kakao.token-uri=https://kauth.kakao.com/oauth/token
spring.security.oauth2.client.provider.kakao.user-info-uri=https://kapi.kakao.com/v2/user/me
spring.security.oauth2.client.provider.kakao.user-name-attribute=id

spring.cloud.aws.s3.enabled=false
spring.cloud.aws.stack.auto=false
logging.level.org.springframework.security.oauth2.client=DEBUG
logging.level.org.springframework.web.client.RestTemplate=DEBUG
mock.login.user=false

backend.base-url=${{ secrets.BACKEND_BASE_URL }}
frontend.base-url=${{ secrets.FRONTEND_BASE_URL }}
frontend.redirect-url=\${frontend.base-url}/oauth-redirect
spring.graphql.cors.allowed-origins=\${frontend.base-url}

ai.server.url=${{ secrets.AI_SERVER_URL }}
ai.server.url.path=/spec/v1/post
EOF

            echo "‚òï JAVA_HOME ÏÑ§Ï†ï Ï§ë..."
            export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which javac))))
            export PATH=$JAVA_HOME/bin:$PATH
            echo "‚úÖ JAVA_HOME: $JAVA_HOME"

            echo "üöÄ Spring Boot ÌîÑÎ°úÏ†ùÌä∏ ÎπåÎìú ÏãúÏûë (ÌÖåÏä§Ìä∏ ÏÉùÎûµ)..."
            ./gradlew clean build --no-daemon --refresh-dependencies -x test || { echo "‚ùå ÎπåÎìú Ïã§Ìå®"; exit 1; }

            JAR_FILE=$(find build/libs -name "*.jar" | head -n 1)

            if [ -z "$JAR_FILE" ]; then
              echo "‚ùå JAR ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§."
              exit 1
            fi

            echo "‚úÖ JAR ÌååÏùº Ï∞æÏùå: $(basename "$JAR_FILE")"

            echo "üîÅ Î∞±ÏóîÎìú ÏÑúÎ≤Ñ Ïû¨ÏãúÏûë..."
            EXISTING_PID=$(pgrep -f 'java -jar')
            if [ -n "$EXISTING_PID" ]; then
              echo "üõë Í∏∞Ï°¥ Î∞±ÏóîÎìú ÌîÑÎ°úÏÑ∏Ïä§ Ï¢ÖÎ£å (PID: $EXISTING_PID)"
              kill $EXISTING_PID
              sleep 2
            else
              echo "‚úÖ Ïã§Ìñâ Ï§ëÏù∏ Î∞±ÏóîÎìú ÏóÜÏùå"
            fi

            echo "üöÄ ÏÉàÎ°úÏö¥ Î∞±ÏóîÎìú Ïã§Ìñâ Ï§ë..."
            nohup java -jar "$JAR_FILE" --server.port=8080 --spring.profiles.active=auth,ai,no-spec-initialize,no-user-initialize > $LOG_FILE 2>&1 &

            echo "‚úÖ Î∞±ÏóîÎìú Ïã§Ìñâ ÏôÑÎ£å (Î°úÍ∑∏: $LOG_FILE)"
