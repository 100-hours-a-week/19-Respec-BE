name: Deploy Backend to EC2

on:
  push:
    branches:
      - stage

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      # - name: Check EC2 status and start if stopped
      #   id: ec2
      #   run: |
      #     INSTANCE_ID=${{ secrets.EC2_INSTANCE_ID }}
      #     STATE=$(aws ec2 describe-instances \
      #       --instance-ids $INSTANCE_ID \
      #       --query "Reservations[0].Instances[0].State.Name" \
      #       --output text)

      #     echo "EC2 instance state: $STATE"

      #     if [ "$STATE" = "stopped" ]; then
      #       echo "Starting EC2 instance..."
      #       aws ec2 start-instances --instance-ids $INSTANCE_ID
      #       echo "Waiting for EC2 to be running..."
      #       aws ec2 wait instance-running --instance-ids $INSTANCE_ID
      #     fi

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            REPO_DIR=19-Respec-BE
            LOG_FILE=~/backend.log

            if [ ! -d "$REPO_DIR" ]; then
              git clone https://github.com/100-hours-a-week/19-Respec-BE.git
            fi

            cd $REPO_DIR
            git checkout stage
            git pull origin stage

            echo "â˜• JAVA_HOME ì„¤ì • ì¤‘..."
            export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which javac))))
            export PATH=$JAVA_HOME/bin:$PATH
            echo "âœ… JAVA_HOME: $JAVA_HOME"

            echo "ðŸš€ Spring Boot í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹œìž‘ (í…ŒìŠ¤íŠ¸ ìƒëžµ)..."
            ./gradlew clean build -x test || { echo "âŒ ë¹Œë“œ ì‹¤íŒ¨"; exit 1; }

            JAR_FILE=$(find build/libs -name "*.jar" | head -n 1)

            if [ -z "$JAR_FILE" ]; then
              echo "âŒ JAR íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi

            echo "âœ… JAR íŒŒì¼ ì°¾ìŒ: $(basename "$JAR_FILE")"

            echo "ðŸ” ë°±ì—”ë“œ ì„œë²„ ìž¬ì‹œìž‘..."
            EXISTING_PID=$(pgrep -f 'java -jar')
            if [ -n "$EXISTING_PID" ]; then
              echo "ðŸ›‘ ê¸°ì¡´ ë°±ì—”ë“œ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (PID: $EXISTING_PID)"
              kill $EXISTING_PID
              sleep 2
            else
              echo "âœ… ì‹¤í–‰ ì¤‘ì¸ ë°±ì—”ë“œ ì—†ìŒ"
            fi

            echo "ðŸš€ ìƒˆë¡œìš´ ë°±ì—”ë“œ ì‹¤í–‰ ì¤‘..."
            nohup java -jar "$JAR_FILE" --server.port=8080 > $LOG_FILE 2>&1 &

            echo "âœ… ë°±ì—”ë“œ ì‹¤í–‰ ì™„ë£Œ (ë¡œê·¸: $LOG_FILE)"
